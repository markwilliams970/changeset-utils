<!DOCTYPE html>
<html>
<head>
    <title>Artifact Changeset Helper</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ArtifactChangesetHelper",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"labelContainer",html:"Select a Story, Defect, or Task:",padding:"10px"},{xtype:"container",itemId:"controlsContainer",columnWidth:1},{xtype:"container",itemId:"gridContainer",columnWidth:1}],_rallyServer:null,_scmRepositories:null,_selectedArtifact:null,_artifactChangesetsByChangesetOid:{},_changesetArtifactsByChangesetOid:{},_moveChangesetTargetArtifact:null,_openSelectDialogButton:null,_artifactGrid:null,_changesetGrid:null,_missingRequireDataDialog:null,_targetArtifactChooserDialog:null,_moveChangesetAttributesDialog:null,_moveChangesetTargetArtifactCombobox:null,launch:function(){var me=this;this._getHostName(),this._getSCMRepositories(),this._currentUser=this.getContext().getUser()},_getSCMRepositories:function(){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"SCMRepository",fetch:["ObjectID","Name","Uri"],autoLoad:!0,limit:4e3,context:{projectScopeUp:!1,projectScopeDown:!1},listeners:{scope:this,load:function(store,data){me._scmRepositories=data,this._buildUI()}}})},_buildUI:function(){var me=this;this._openSelectDialogButton=Ext.create("Rally.ui.Button",{text:"Select an Artifact",handler:function(){me._createSelectInitialArtifactDialog()}}),this.down("#controlsContainer").add(this._openSelectDialogButton)},_getHostName:function(){testUrl=window.location.hostname||"rally1.rallydev.com",testUrlSplit=testUrl.split("/"),this._rallyHost=1===testUrlSplit.length?"rally1.rallydev.com":testUrlSplit[2],this._rallyServer="https://"+this._rallyHost},_createSelectInitialArtifactDialog:function(){var me=this;me._selectInitialArtifactDialog=Ext.create("Rally.ui.dialog.ChooserDialog",{artifactTypes:["UserStory","Defect","Task"],autoShow:!0,height:600,title:"Choose Artifact",listeners:{artifactChosen:function(artifact){me._hydrateData(artifact)},scope:me}})},_hydrateData:function(record){var me=this;me.setLoading("Loading Changeset Data..."),me._selectedArtifact=record,me._artifactChangesetsByChangesetOid={},me._changesetArtifactsByChangesetOid={};var getArtifactChangesetCollectionPromise=function(){return me._getArtifactChangesetCollection(me)},getChangesetStoriesCollectionPromise=function(){return me._getChangesetArtifactsCollection(me,"UserStory")},getChangesetDefectsCollectionPromise=function(){return me._getChangesetArtifactsCollection(me,"Defect")},getChangesetTasksCollectionPromise=function(){return me._getChangesetArtifactsCollection(me,"Task")},promises=[getArtifactChangesetCollectionPromise,getChangesetStoriesCollectionPromise,getChangesetDefectsCollectionPromise,getChangesetTasksCollectionPromise];Deft.Chain.sequence(promises).then({scope:this,success:function(records){me._makeGrids(me)},failure:function(error){deferred.reject("Problem resolving chain "+error)}})},_getArtifactChangesetCollection:function(scope){var me=scope,artifact=me._selectedArtifact,promises=[],deferred=Ext.create("Deft.Deferred");return promises.push(me._hydrateArtifactChangesets(artifact,me)),Deft.Promise.all(promises).then({success:function(results){var theseChangesets=results[0];Ext.Array.each(theseChangesets,function(changeset){var changesetOID=changeset.get("ObjectID");me._artifactChangesetsByChangesetOid[changesetOID]=changeset}),deferred.resolve([])}}),deferred},_hydrateArtifactChangesets:function(artifact,scope){var deferred=Ext.create("Deft.Deferred"),me=scope,changeSets=[],artifactRef=artifact.get("_ref"),artifactObjectID=artifact.get("ObjectID"),artifactFormattedID=artifact.get("FormattedID"),artifactName=artifact.get("Name"),changesetCollection=artifact.getCollection("Changesets",{fetch:["Author","Artifacts","Name","Revision","Message","CommitTimestamp"]}),changesetCount=changesetCollection.getCount();return changesetCollection.load({callback:function(records,operation,success){deferred.resolve(records)}}),deferred},_getHashLength:function(hash){var size=0,key;for(key in hash)hash.hasOwnProperty(key)&&size++;return size},_getChangesetArtifactsCollection:function(scope,type){var me=scope,changesetsByChangesetOID=me._artifactChangesetsByChangesetOid,promises=[],deferred=Ext.create("Deft.Deferred");return me._getHashLength(changesetsByChangesetOID)>0?(Ext.iterate(changesetsByChangesetOID,function(OID,changeset){promises.push(me._hydrateChangesetArtifacts(changeset,type,me))}),Deft.Promise.all(promises).then({success:function(results){deferred.resolve([])}})):deferred.resolve([]),deferred},_hydrateChangesetArtifacts:function(changeset,artifactType,scope){var me=scope,deferred=Ext.create("Deft.Deferred"),changesetRef=changeset.get("_ref"),changesetObjectID=changeset.get("ObjectID"),changesetArtifacts=[];return me._changesetArtifactsByChangesetOid[changesetObjectID]&&(changesetArtifacts=me._changesetArtifactsByChangesetOid[changesetObjectID]),Ext.create("Rally.data.wsapi.Store",{model:artifactType,autoLoad:!0,fetch:["Name","FormattedID","ObjectID"],filters:[{property:"Changesets.ObjectID",operator:"=",value:changesetObjectID}],listeners:{load:function(store,records,success){Ext.Array.each(records,function(artifact){changesetArtifacts.push(artifact)}),me._changesetArtifactsByChangesetOid[changesetObjectID]=changesetArtifacts,deferred.resolve([])}}}),deferred},_makeGrids:function(scope){var me=scope;me._makeArtifactGrid(me)},_makeArtifactGrid:function(scope){var me=scope;me._artifactGrid&&me._artifactGrid.destroy();var gridStore=Ext.create("Rally.data.custom.Store",{data:me._selectedArtifact,pageSize:1,remoteSort:!1});me._artifactGrid=Ext.create("Rally.ui.grid.Grid",{itemId:"artifactGrid",store:gridStore,columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1},{text:"Create Changeset",renderer:function(value,model,record){var id=Ext.id();return Ext.defer(function(){Ext.widget("button",{renderTo:id,text:"New Changeset",width:120,handler:function(){me._createChangesetDialog(record,me)}})},50),Ext.String.format('<div id="{0}"></div>',id)},flex:1}]}),me.down("#gridContainer").add(me._artifactGrid),me._artifactGrid.reconfigure(gridStore),me._makeChangesetGrid(me)},_createChangesetDialog:function(artifact,scope){var me=scope,message="Define New Changeset Attributes",confirmLabel="Create Changeset";me._moveChangesetAttributesDialog=Ext.create("ArtifactChangesetHelper.ChangesetNewAttribsDialog",{message:message,targetFormattedID:artifact.get("FormattedID"),confirmLabel:confirmLabel,showRevisionField:!0,scmRepositories:me._scmRepositories,listeners:{confirm:function(dialog,commitMessage,revisionNumber,scmRepository){me._createNewChangeset(artifact,commitMessage,revisionNumber,scmRepository,scope)}}})},_createNewChangeset:function(artifact,commitMessage,revisionNumber,scmRepository,scope){var me=scope;if(commitMessage&&revisionNumber&&scmRepository)var commitTimestamp=Rally.util.DateTime.toIsoString(new Date,!0),changesetModel=Rally.data.ModelFactory.getModel({type:"Changeset",scope:this,success:function(model,operation){var newChangesetRecord=Ext.create(model,{Revision:revisionNumber,SCMRepository:{_ref:scmRepository.get("_ref")},Artifacts:[{_ref:artifact.get("_ref")}],Message:commitMessage,CommitTimestamp:commitTimestamp,Author:{_ref:me._currentUser._ref}});newChangesetRecord.save({callback:function(result,operation){if(operation.wasSuccessful()){var successMessage="Successfully Created New Changeset!";Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Changeset Created!",message:successMessage,confirmLabel:"Ok",listeners:{confirm:function(){Ext.defer(function(){me._changesetGrid&&me._hydrateData(artifact)},500)}}})}else Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Changeset Not Created",message:"Error Creating Changeset!",confirmLabel:"Ok",listeners:{confirm:function(){}}})}})}});else me._missingRequiredData(me)},_missingRequiredData:function(scope){var me=this;me._missingRequireDataDialog&&me._missingRequireDataDialog.destroy(),me._missingRequireDataDialog=Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Missing Requied Changeset Data.",message:"Please include Revision, SCMRepo, and Message",confirmLabel:"Ok",listeners:{confirm:function(){}}})},_makeChangesetGrid:function(scope){var me=scope;me._changesetGrid&&me._changesetGrid.destroy();var changesets=[];Ext.iterate(me._artifactChangesetsByChangesetOid,function(OID,changeset){var changesetOID=OID,changesetArtifacts=me._changesetArtifactsByChangesetOid[changesetOID]||[],changesetWithArtifacts={_ref:changeset.get("_ref"),ObjectID:changeset.get("ObjectID"),Name:changeset.get("Name"),Revision:changeset.get("Revision"),CommitTimestamp:changeset.get("CommitTimestamp")||"",Message:changeset.get("Message"),Author:changeset.get("Author"),Artifacts:changesetArtifacts};changesets.push(changesetWithArtifacts)});var gridStore=Ext.create("Rally.data.custom.Store",{data:changesets,pageSize:1e3,remoteSort:!1});me._changesetGrid=Ext.create("Rally.ui.grid.Grid",{itemId:"changesetGrid",store:gridStore,columnCfgs:[{text:"Name",dataIndex:"Name",flex:1},{text:"Revision",dataIndex:"Revision"},{text:"Commit Time Stamp",dataIndex:"CommitTimestamp"},{text:"Author",dataIndex:"Author",renderer:function(value){return value?value._refObjectName:void 0}},{text:"Artifacts",dataIndex:"Artifacts",renderer:function(values){var artifactsHtml=[];return Ext.Array.each(values,function(artifact){var artifactObjectID=artifact.get("ObjectID"),artifactFormattedID=artifact.get("FormattedID"),artifactName=artifact.get("Name"),artifactType=artifact.get("_type");"hierarchicalrequirement"===artifactType&&(artifactType="userstory");var artifactLabel=artifactFormattedID+": "+artifactName,linkTemplate=new Ext.Template('<a href="{rallyServer}/#/detail/{artifactType}/{artifactOID}" target="_blank">{artifactLabel}</a>'),artifactHtml=linkTemplate.apply({rallyServer:me._rallyServer,artifactType:artifactType,artifactOID:artifactObjectID,artifactLabel:artifactLabel});artifactsHtml.push(artifactHtml)}),artifactsHtml.join("<br/> ")},flex:1},{text:"Message",dataIndex:"Message",flex:1},{text:"Move",renderer:function(value,model,record){var id=Ext.id();return Ext.defer(function(){Ext.widget("button",{renderTo:id,text:"Move Changeset",width:120,handler:function(){me._selectTargetArtifactForChangesetMove(record.data,me)}})},50),Ext.String.format('<div id="{0}"></div>',id)},flex:1},{text:"Delete",renderer:function(value,model,record){var id=Ext.id();return Ext.defer(function(){Ext.widget("button",{renderTo:id,text:"Delete Changeset",width:120,handler:function(){me._confirmDeleteChangeset(record.data,me)}})},50),Ext.String.format('<div id="{0}"></div>',id)},flex:1}]}),me.down("#gridContainer").add(me._changesetGrid),me._changesetGrid.reconfigure(gridStore),me.setLoading(!1)},_selectTargetArtifactForChangesetMove:function(changesetrecord,scope){var me=scope;me._targetArtifactChooserDialog=Ext.create("Rally.ui.dialog.ChooserDialog",{artifactTypes:["UserStory","Defect","Task"],autoShow:!0,height:600,title:"Choose Target Artifact to Receive Changeset",listeners:{artifactChosen:function(targetartifact){me._createMoveChangesetAttributesDialog(changesetrecord,targetartifact,scope)},scope:this}})},_createMoveChangesetAttributesDialog:function(sourcechangeset,targetartifact,scope){var me=scope,message="Define Updated Changeset Attributes",confirmLabel="Move Changeset",currentCommitMessage=sourcechangeset.Message||"";me._moveChangesetAttributesDialog=Ext.create("ArtifactChangesetHelper.ChangesetNewAttribsDialog",{message:message,targetFormattedID:targetartifact.get("FormattedID"),currentCommitMessage:currentCommitMessage,confirmLabel:confirmLabel,listeners:{confirm:function(dialog,newcommitmessage){me._moveChangeset(sourcechangeset,targetartifact,newcommitmessage,scope)}}})},_moveChangeset:function(sourcechangeset,targetartifact,newcommitmessage,scope){var me=scope,changesetOID=sourcechangeset.ObjectID,changesetModel=Rally.data.ModelFactory.getModel({type:"Changeset",scope:this,success:function(model,operation){model.load(changesetOID,{scope:this,success:function(changesetHydrated,operation){var sourceArtifact=me._selectedArtifact,sourceArtifactRef=sourceArtifact.get("_ref"),existingArtifacts=me._changesetArtifactsByChangesetOid[changesetOID],existingArtifactRefs=[];Ext.Array.each(existingArtifacts,function(artifact){existingArtifactRefs.push(artifact.get("_ref"))});var updatedArtifactRefs=existingArtifactRefs,index=updatedArtifactRefs.indexOf(sourceArtifactRef);index>-1&&updatedArtifactRefs.splice(index,1),updatedArtifactRefs.push(targetartifact.get("_ref"));var updatedArtifactsArray=_.map(updatedArtifactRefs,function(ref){return{_ref:ref}});changesetHydrated.set("Artifacts",updatedArtifactsArray),changesetHydrated.set("Message",newcommitmessage),changesetHydrated.save({callback:function(result,operation){if(operation.wasSuccessful()){Ext.defer(function(){delete me._artifactChangesetsByChangesetOid[changesetOID]},100);var successMessage="Changeset Successfully Moved To: "+targetartifact.get("FormattedID");Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Changeset Moved",message:successMessage,confirmLabel:"Ok",listeners:{confirm:function(){Ext.defer(function(){me._changesetGrid&&(me._changesetGrid.destroy(),me._makeChangesetGrid(me))},500)}}})}else Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Changeset Not Moved",message:"Error Moving Changeset!",confirmLabel:"Ok",listeners:{confirm:function(){}}})}})}})}})},_confirmDeleteChangeset:function(record,scope){var me=scope,confirmLabel="Delete Changeset Permanently",message="Really Delete Changeset? Deleted Changeset cannot be recovered.";Ext.create("Rally.ui.dialog.ConfirmDialog",{message:message,confirmLabel:confirmLabel,listeners:{confirm:function(){me._deleteChangeset(record,scope)}}})},_deleteChangeset:function(record,scope){var me=scope,changesetOID=record.ObjectID,changesetModel=Rally.data.ModelFactory.getModel({type:"Changeset",scope:this,success:function(model,operation){model.load(changesetOID,{scope:this,success:function(changesetHydrated,operation){changesetHydrated.destroy({callback:function(result,operation){operation.wasSuccessful()?(Ext.defer(function(){delete me._artifactChangesetsByChangesetOid[changesetOID]},100),Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Changeset Deleted",message:"Changeset Successfully Removed!",confirmLabel:"Ok",listeners:{confirm:function(){Ext.defer(function(){me._changesetGrid&&(me._changesetGrid.destroy(),me._makeChangesetGrid(me))},500)}}})):Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Changeset Not Removed",message:"Error Removing Changeset!",confirmLabel:"Ok",listeners:{confirm:function(){}}})}})}})}})}});
                Ext.define("ArtifactChangesetHelper.ChangesetNewAttribsDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.newchangesetattributes",requires:["Rally.ui.Button","Rally.ui.dialog.Dialog","Rally.ui.TextField"],clientMetrics:{beginEvent:"beforeshow",endEvent:"show",description:"dialog shown"},width:350,closable:!0,autoShow:!0,cls:"rally-confirm-dialog",title:"",message:"",showRevisionField:!1,currentCommitMessage:"",targetFormattedID:"",confirmLabel:"Continue",cancelLabel:"Cancel",_scmRepositoriesCombobox:null,_selectedSCMRepo:null,items:[{xtype:"component",itemId:"confirmMsg",cls:"confirmMessage"},{xtype:"rallytextfield",fieldLabel:"Target FormattedID:",itemId:"targetFmtId",cls:"targetFormattedID"},{xtype:"rallytextfield",fieldLabel:"Current Commit Message:",itemId:"currentCommitMsg",cls:"currentCommitMessage"},{xtype:"rallytextfield",fieldLabel:"Revision:",itemId:"revisionNbr"},{xtype:"container",itemId:"scmReposContainer"},{xtype:"rallytextfield",fieldLabel:"New Commit Message:",itemId:"newCommitMsg"}],dockedItems:[{xtype:"toolbar",dock:"bottom",padding:"10",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",cls:"confirm primary small",itemId:"confirmButton",userAction:"clicked yes in dialog"},{xtype:"rallybutton",cls:"cancel secondary small",itemId:"cancelButton",ui:"link"}]}],constructor:function(config){this.callParent(arguments),this.autoCenter&&(this.scrollListener.saveScrollPosition=!0),config.currentCommitMessage&&(this.currentCommitMessage=config.currentCommitMessage),config.targetFormattedID&&(this.targetFormattedID=config.targetFormattedID),config.showRevisionField&&(this.showRevisionField=config.showRevisionField),config.scmRepositories&&(this.scmRepositories=config.scmRepositories)},initComponent:function(){if(this.callParent(arguments),this.addEvents("confirm","cancel"),this.down("#confirmButton").on("click",this._onConfirm,this),this.down("#confirmButton").setText(this.confirmLabel),this.down("#cancelButton").on("click",this._onCancel,this),this.down("#cancelButton").setText(this.cancelLabel),this.message?this.down("#confirmMsg").update(this.message):this.down("#confirmMsg").hide(),this.currentCommitMessage?(this.down("#currentCommitMsg").setValue(this.currentCommitMessage),this.down("#currentCommitMsg").setDisabled(!0)):this.down("#currentCommitMsg").hide(),this.targetFormattedID?(this.down("#targetFmtId").setValue(this.targetFormattedID),this.down("#targetFmtId").setDisabled(!0)):this.down("#targetFmtId").hide(),this.showRevisionField||this.down("#revisionNbr").hide(),this.scmRepositories){var me=this,scmReposData=[];Ext.Array.each(this.scmRepositories,function(scmrepository){scmReposData.push({name:scmrepository.get("Name"),_ref:scmrepository.get("_ref")})});var scmReposStore=Ext.create("Ext.data.Store",{fields:["name","_ref"],data:scmReposData});me._scmRepositoriesCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose SCM Repo:",store:scmReposStore,queryMode:"local",displayField:"name",valueField:"type",minWidth:500,listeners:{scope:this,select:me._selectSCMRepo}}),this.down("#scmReposContainer").add(me._scmRepositoriesCombobox)}},_selectSCMRepo:function(combobox,records){var me=this;me._selectedSCMRepo=records[0]},show:function(){this.autoCenter&&this._saveScrollPosition(),this.callParent(arguments)},close:function(){this._onCancel()},_onConfirm:function(){this._scmRepositoriesCombobox?this.fireEvent("confirm",this,this.down("#newCommitMsg").getValue(),this.down("#revisionNbr").getValue(),this._selectedSCMRepo):this.fireEvent("confirm",this,this.down("#newCommitMsg").getValue(),this.down("#revisionNbr").getValue()),this.destroy()},_onCancel:function(){this.fireEvent("cancel",this),this.destroy()},_saveScrollPosition:function(){this.savedScrollPosition={xOffset:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,yOffset:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}}});

            Rally.launchApp('ArtifactChangesetHelper', {
                name:"Artifact Changeset Helper",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body></body>
</html>
