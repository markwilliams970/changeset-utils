<!DOCTYPE html>
<html>
<head>
    <title>Changeset Mover</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("ChangesetMover",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"labelContainer",html:"Find Changesets With Commit Timestamps Between:",padding:"10px"},{xtype:"container",itemId:"startDateTimeChooser",flex:1,layout:"hbox",padding:"10px"},{xtype:"container",itemId:"endDateTimeChooser",flex:1,layout:"hbox",padding:"10px"},{xtype:"container",itemId:"controlsContainer",columnWidth:1},{xtype:"container",itemId:"gridContainer",columnWidth:1}],_startDateString:null,_endDateString:null,_startHourString:"00",_endHourString:"23",_startMinuteString:"00",_endMinuteString:"59",_startHourCombobox:null,_startMinuteCombobox:null,_startDateTextField:null,_startDateChooserDialog:null,_endHourCombobox:null,_endMinuteCombobox:null,_endDateTextField:null,_endDateChooserDialog:null,_startDateIsInFutureDialog:null,_startDateIsGTEndDateDialog:null,_findChangesetsButton:null,launch:function(){var me=this;me._initializeDefaultDates();var startDateText=me._startDateString;this._startDateTextField=Ext.create("Rally.ui.TextField",{fieldLabel:"Start Date",value:startDateText,listeners:{render:function(){this.getEl().on("mousedown",function(e,t,eOpts){me._createStartDateChooserDialog()})}}});var endDateText=me._endDateString;this._endDateTextField=Ext.create("Rally.ui.TextField",{fieldLabel:"End Date",value:endDateText,listeners:{render:function(){this.getEl().on("mousedown",function(e,t,eOpts){me._createEndDateChooserDialog()})}}});for(var hourData=[],i=0;23>=i;i++){var hourKeyAndValue=me._padIntegerToString(i,2),record={name:hourKeyAndValue,value:hourKeyAndValue};hourData.push(record)}var hourStore=Ext.create("Ext.data.Store",{fields:["name","value"],data:hourData});this._startHourCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Start Hour:",store:hourStore,queryMode:"local",displayField:"name",valueField:"value",value:hourStore.getAt(0).get("value"),listeners:{scope:this,select:function(combobox,records){me._startHourString=records[0].get("value")}}}),this._endHourCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"End Hour:",store:hourStore,queryMode:"local",displayField:"name",valueField:"value",value:hourStore.getAt(23).get("value"),listeners:{scope:this,select:function(combobox,records){me._endHourString=records[0].get("value")}}});var minuteData=[];for(i=0;59>=i;i++){var minuteKeyAndValue=me._padIntegerToString(i,2),minuteRecord={name:minuteKeyAndValue,value:minuteKeyAndValue};minuteData.push(minuteRecord)}var minuteStore=Ext.create("Ext.data.Store",{fields:["name","value"],data:minuteData});this._startMinuteCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Start Minute:",store:minuteStore,queryMode:"local",displayField:"name",valueField:"value",value:minuteStore.getAt(0).get("value"),listeners:{scope:this,select:function(combobox,records){me._startMinuteString=records[0].getValue()}}}),this._endMinuteCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"End Minute:",store:minuteStore,queryMode:"local",displayField:"name",valueField:"value",value:minuteStore.getAt(59).get("value"),listeners:{scope:this,select:function(combobox,records){me._endMinuteString=records[0].get("value")}}}),this.down("#startDateTimeChooser").add(this._startDateTextField),this.down("#startDateTimeChooser").add(this._startHourCombobox),this.down("#startDateTimeChooser").add(this._startMinuteCombobox),this.down("#endDateTimeChooser").add(this._endDateTextField),this.down("#endDateTimeChooser").add(this._endHourCombobox),this.down("#endDateTimeChooser").add(this._endMinuteCombobox),this._findChangesetsButton=Ext.create("Ext.Container",{items:[{xtype:"rallybutton",text:"Look For Changesets",handler:function(){me._validateTimebox()}}]}),this.down("#controlsContainer").add(this._findChangesetsButton)},_initializeDefaultDates:function(){console.log("_initializeDefaultDates");var me=this;me._startDateString=me._dateToISOString(new Date,!1,!0),me._endDateString=me._dateToISOString(new Date,!1,!0)},_padIntegerToString:function(num,size){console.log("_padIntegerToString");for(var numToPad=Math.abs(num),paddedString=numToPad+"";size>paddedString.length;)paddedString="0"+paddedString;return num>=0?paddedString:"-"+paddedString},_createStartDateChooserDialog:function(){console.log("_createStartDateChooserDialog");var me=this;me._startDateChooserDialog&&me._startDateChooserDialog.destroy();var label="Choose Start Commit Date:",defaultDate=new Date,confirmLabel="Ok",maxDate=new Date;me._startDateChooserDialog=Ext.create("ChangesetMover.ChooseDateDialog",{calendarLabel:label,defaultDate:defaultDate,confirmLabel:confirmLabel,maxDate:maxDate,listeners:{confirm:function(dialog,chosendate){me._startDateString=me._dateToISOString(chosendate,!1,!0),me._startDateTextField.setValue(me._startDateString)}}})},_createEndDateChooserDialog:function(){console.log("_createEndDateChooserDialog");var me=this;me._endDateChooserDialog&&me._endDateChooserDialog.destroy();var label="Choose End Commit Date:",defaultDate=new Date,confirmLabel="Ok";me._endDateChooserDialog=Ext.create("ChangesetMover.ChooseDateDialog",{calendarLabel:label,defaultDate:defaultDate,confirmLabel:confirmLabel,listeners:{confirm:function(dialog,chosendate){me._endDateString=me._dateToISOString(chosendate,!1,!0),me._endDateTextField.setValue(me._endDateString)}}})},_validateTimebox:function(){var me=this,startDate_LocalTime_StringFormat=me._getDateStringWithUTCOffset(me._startDateString,me._startHourString,me._startMinuteString),endDate_LocalTime_StringFormat=me._getDateStringWithUTCOffset(me._endDateString,me._endHourString,me._endMinuteString),now=new Date,nowUTCString=me._dateToISOString(now,!0,!1),nowUTC=Rally.util.DateTime.fromIsoString(nowUTCString),startDateUTC=Rally.util.DateTime.fromIsoString(startDate_LocalTime_StringFormat),endDateUTC=Rally.util.DateTime.fromIsoString(endDate_LocalTime_StringFormat);if(startDateUTC>=nowUTC)return me._startDateIsInFutureNotify(),void 0;if(startDateUTC>=endDateUTC)return me._startDateIsGTEndDateNotify(),void 0;var startDateStringUTC=me._dateToISOString(startDateUTC,!0,!1),endDateStringUTC=me._dateToISOString(endDateUTC,!0,!1);console.log(startDateStringUTC),console.log(endDateStringUTC)},_dateToISOString:function(date,convertToUTC,stripTimePortion){return stripTimePortion?Rally.util.DateTime.toIsoString(date,convertToUTC).replace(/T[\W\w]*/,""):Rally.util.DateTime.toIsoString(date,convertToUTC)},_getDateStringWithUTCOffset:function(dateString,hourString,minuteString){var me=this,dateTimeSeparator="T",timeDelim=":",secondsString="00",offsetMinutesString="00",offsetHoursString=me._getUTCOffsetString();return dateString+dateTimeSeparator+hourString+timeDelim+minuteString+timeDelim+secondsString+offsetHoursString+timeDelim+offsetMinutesString},_getUTCOffsetString:function(){return this._padIntegerToString(parseInt(Ext.Date.format(new Date,"Z"),10)/3600,2)},_startDateIsInFutureNotify:function(){var me=this;me._startDateIsInFutureDialog&&me._startDateIsInFutureDialog.destroy(),me._startDateIsInFutureDialog=Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Start Date/Time is in the Future",message:"Please Select Start Date/Time that's in the past.",confirmLabel:"Ok",listeners:{confirm:function(){}}})},_startDateIsGTEndDateNotify:function(){var me=this;me._startDateIsGTEndDateDialog&&me._startDateIsGTEndDate.destroy(),me._startDateIsGTEndDate=Ext.create("Rally.ui.dialog.ConfirmDialog",{title:"Start Date/Time is greater than End Date/Time",message:"Please Select Start Date/Time that's before End Date/Time",confirmLabel:"Ok",listeners:{confirm:function(){}}})}});
                Ext.define("ArtifactChangesetHelper.ChangesetNewAttribsDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.newchangesetattributes",requires:["Rally.ui.Button","Rally.ui.dialog.Dialog","Rally.ui.TextField"],clientMetrics:{beginEvent:"beforeshow",endEvent:"show",description:"dialog shown"},width:350,closable:!0,autoShow:!0,cls:"rally-confirm-dialog",title:"",message:"",showRevisionField:!1,currentCommitMessage:"",targetFormattedID:"",confirmLabel:"Continue",cancelLabel:"Cancel",_scmRepositoriesCombobox:null,_selectedSCMRepo:null,items:[{xtype:"component",itemId:"confirmMsg",cls:"confirmMessage"},{xtype:"rallytextfield",fieldLabel:"Target FormattedID:",itemId:"targetFmtId",cls:"targetFormattedID"},{xtype:"rallytextfield",fieldLabel:"Current Commit Message:",itemId:"currentCommitMsg",cls:"currentCommitMessage"},{xtype:"rallytextfield",fieldLabel:"Revision:",itemId:"revisionNbr"},{xtype:"container",itemId:"scmReposContainer"},{xtype:"rallytextfield",fieldLabel:"New Commit Message:",itemId:"newCommitMsg"}],dockedItems:[{xtype:"toolbar",dock:"bottom",padding:"10",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",cls:"confirm primary small",itemId:"confirmButton",userAction:"clicked yes in dialog"},{xtype:"rallybutton",cls:"cancel secondary small",itemId:"cancelButton",ui:"link"}]}],constructor:function(config){this.callParent(arguments),this.autoCenter&&(this.scrollListener.saveScrollPosition=!0),config.currentCommitMessage&&(this.currentCommitMessage=config.currentCommitMessage),config.targetFormattedID&&(this.targetFormattedID=config.targetFormattedID),config.showRevisionField&&(this.showRevisionField=config.showRevisionField),config.scmRepositories&&(this.scmRepositories=config.scmRepositories)},initComponent:function(){if(this.callParent(arguments),this.addEvents("confirm","cancel"),this.down("#confirmButton").on("click",this._onConfirm,this),this.down("#confirmButton").setText(this.confirmLabel),this.down("#cancelButton").on("click",this._onCancel,this),this.down("#cancelButton").setText(this.cancelLabel),this.message?this.down("#confirmMsg").update(this.message):this.down("#confirmMsg").hide(),this.currentCommitMessage?(this.down("#currentCommitMsg").setValue(this.currentCommitMessage),this.down("#currentCommitMsg").setDisabled(!0)):this.down("#currentCommitMsg").hide(),this.targetFormattedID?(this.down("#targetFmtId").setValue(this.targetFormattedID),this.down("#targetFmtId").setDisabled(!0)):this.down("#targetFmtId").hide(),this.showRevisionField||this.down("#revisionNbr").hide(),this.scmRepositories){var me=this,scmReposData=[];Ext.Array.each(this.scmRepositories,function(scmrepository){scmReposData.push({name:scmrepository.get("Name"),_ref:scmrepository.get("_ref")})});var scmReposStore=Ext.create("Ext.data.Store",{fields:["name","_ref"],data:scmReposData});me._scmRepositoriesCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose SCM Repo:",store:scmReposStore,queryMode:"local",displayField:"name",valueField:"type",minWidth:500,listeners:{scope:this,select:me._selectSCMRepo}}),this.down("#scmReposContainer").add(me._scmRepositoriesCombobox)}},_selectSCMRepo:function(combobox,records){var me=this;me._selectedSCMRepo=records[0]},show:function(){this.autoCenter&&this._saveScrollPosition(),this.callParent(arguments)},close:function(){this._onCancel()},_onConfirm:function(){this._scmRepositoriesCombobox?this.fireEvent("confirm",this,this.down("#newCommitMsg").getValue(),this.down("#revisionNbr").getValue(),this._selectedSCMRepo):this.fireEvent("confirm",this,this.down("#newCommitMsg").getValue(),this.down("#revisionNbr").getValue()),this.destroy()},_onCancel:function(){this.fireEvent("cancel",this),this.destroy()},_saveScrollPosition:function(){this.savedScrollPosition={xOffset:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,yOffset:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}}});
                Ext.define("ChangesetMover.ChooseDateDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.choosedate",requires:["Rally.ui.Button","Rally.ui.dialog.Dialog","Rally.ui.TextField"],clientMetrics:{beginEvent:"beforeshow",endEvent:"show",description:"dialog shown"},width:350,closable:!0,autoShow:!0,cls:"rally-confirm-dialog",title:"",message:"",confirmLabel:"Continue",cancelLabel:"Cancel",defaultDate:null,selectedDate:null,calendar:null,items:[{xtype:"component",itemId:"confirmMsg",cls:"confirmMessage"},{xtype:"container",itemId:"calendarContainer"}],dockedItems:[{xtype:"toolbar",dock:"bottom",padding:"10",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",cls:"confirm primary small",itemId:"confirmButton",userAction:"clicked yes in dialog"},{xtype:"rallybutton",cls:"cancel secondary small",itemId:"cancelButton",ui:"link"}]}],constructor:function(config){this.callParent(arguments),this.autoCenter&&(this.scrollListener.saveScrollPosition=!0),this.defaultDate=new Date,config.defaultDate&&(this.defaultDate=config.defaultDate),this.selectedDate=this.defaultDate,config.calendarLabel&&(this.calendarLabel=config.calendarLabel),config.maxDate&&(this.maxDate=config.maxDate)},initComponent:function(){var me=this;this.callParent(arguments),this.addEvents("confirm","cancel"),this.down("#confirmButton").on("click",this._onConfirm,this),this.down("#confirmButton").setText(this.confirmLabel),this.down("#cancelButton").on("click",this._onCancel,this),this.down("#cancelButton").setText(this.cancelLabel),this.message?this.down("#confirmMsg").update(this.message):this.down("#confirmMsg").hide();var calendarLabel="Choose a date:";this.calendarLabel&&(calendarLabel=this.calendarLabel);var calendarConfig={title:calendarLabel,width:200,bodyPadding:10,renderTo:Ext.getBody(),items:[{xtype:"datepicker",handler:function(picker,date){console.log(date),me.selectedDate=date}}]};this.maxDate&&(calendarConfig.maxDate=this.maxDate),this.calendar=Ext.create("Ext.panel.Panel",calendarConfig),this.down("#calendarContainer").add(this.calendar)},show:function(){this.autoCenter&&this._saveScrollPosition(),this.callParent(arguments)},close:function(){this._onCancel()},_onConfirm:function(){this.fireEvent("confirm",this,this.selectedDate),this.destroy()},_onCancel:function(){this.fireEvent("cancel",this),this.destroy()},_saveScrollPosition:function(){this.savedScrollPosition={xOffset:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,yOffset:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}}});

            Rally.launchApp('ChangesetMover', {
                name:"Changeset Mover",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
